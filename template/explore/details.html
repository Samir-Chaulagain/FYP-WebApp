{% extends 'base.html' %}

{% load is_item_already_rented %}
{% load is_item_already_saved %}

{% block content %}
{% load static %}

<style>
    .carousel-item {
        height: 375px;
    }

    .with-arrow .nav-link {
        background-color: white;
        border-radius: 40px;
        color: #D10024
    }

    .with-arrow .nav-link:hover {
        background-color: white;
        border-radius: 40px;
        color: black
    }

    .nav-tabs {
        border-bottom: 0px;
    }

    .with-arrow .nav-link.active {
        color: white;
        position: relative;
        background-color: #D10024;
        border: 13px solid;
    }

    .with-arrow .nav-link.active::after {
        content: '';
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 6px solid #D10024;
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        display: block;


    }

    @media (max-width: 576px) {
        .with-arrow .nav-link.active::after {

            position: none;
            display: none;
        }

        .carousel-item {
            height: 250px;
        }

    }


    .product-details .product-name {
        text-transform: uppercase;
        font-size: 22px;
    }

    .product-details .product-rating {
        display: inline-block;
        margin-right: 15px;
    }

    .product-details .product-rating>i {
        color: #E4E7ED;
    }

    .product-details .product-rating>i.fa-star {
        color: #D10024;
    }



    .product-details .product-price {
        display: inline-block;
        font-size: 24px;
        margin-top: 10px;
        margin-bottom: 15px;
        color: #D10024;
    }

    .product-details .product-price .product-old-price {
        font-size: 70%;
        font-weight: 400;
        color: #8D99AE;
    }

    .product-details .product-available {
        font-size: 12px;
        text-transform: uppercase;
        font-weight: 700;
        margin-left: 30px;
        color: #D10024;
    }

    .product-details {
        margin-top: 30px;
        margin-bottom: 30px;
    }




    .product-details .save {
        margin-bottom: 30px;
    }


    .save-btn {
        position: relative;
        border: 2px solid transparent;
        height: 40px;
        padding: 0 30px;
        margin-right: 15px;
        background-color: #ef233c;
        color: #FFF;
        text-transform: uppercase;
        font-weight: 700;
        border-radius: 40px;
        -webkit-transition: 0.2s all;
        transition: 0.2s all;
    }

    .book-now {

        border: 2px solid black;
        height: 40px;
        padding: 0 30px;
        text-transform: uppercase;
        font-weight: 700;
        border-radius: 40px;

    }

    .booked {
        border: 2px solid black;
        height: 40px;
        padding: 0 30px;
        text-transform: uppercase;
        font-weight: 700;
        border-radius: 40px;
    }

    .save-btn>i {
        position: absolute;
        left: 0;
        top: 0;
        width: 40px;
        height: 40px;
        line-height: 38px;
        color: #D10024;
        opacity: 0;
        visibility: hidden;
    }

    .save-btn:hover {
        background-color: #FFF;
        color: #D10024;
        border-color: #D10024;
        padding: 0px 30px 0px 50px;
    }

    .save-btn:hover>i {
        opacity: 1;
        visibility: visible;
    }



    .product-links {
        margin-top: 15px;
        padding-left: 0;
    }

    .product-details .product-links li {
        display: inline-block;
        text-transform: uppercase;
        font-size: 13px;
    }


    .review {
        color: #D10024;
    }

    .checked {
        color: #D10024;
    }

    .my-btn {
        background-color: inherit !important;
        border: 0 !important;
    }

    .reviews li {
        position: relative;
        padding-left: 145px;
        margin-bottom: 10px;

    }

    .reviews .review-heading {
        position: absolute;
        width: 130px;
        left: 0;
        top: 0;
        height: 70px;
    }

    .reviews {
        min-height: 75px;
    }

    .reviews .review-heading .name {
        margin-bottom: 5px;
        margin-top: 0px;
    }

    .reviews .review-heading .date {
        color: #8D99AE;
        font-size: 10px;
        margin: 0;
    }

    .reviews .review-heading .review-rating {
        margin-top: 5px;
    }

    .user-image {
        margin-left: 19%;
    }


    .avg_star {
        margin-left: 42%;
    }

    .comments {
        height: 100px;
        width: 55%;
        margin-top: 30px;
        margin-left: 24%;
    }

    @media (max-width: 546px) {
        .user-image {
            margin-left: 18%;
        }

        .avg_star {
            margin-left: 0;

        }

        .review-section {
            margin-left: 25%;
        }

        .comments {
            margin-left: 0;
            width: 100%;

        }
    }
</style>



<div class="text-center bg-image" data-aos="zoom-in-up"
    style="
      background-image: url('{% static 'img/about/aboutus2.jpg' %}'); height: 600px; background-repeat: no-repeat; background-size:cover; margin-top:-100px; opacity:96% ;">

    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="container">
            <div class="row align-items-center justify-content-center">

                <div class="col-md-12">
                    <h1 class="text-white font-weight-bold">Explore</h1>
                    <div class="custom-breadcrumbs">
                        <a href="{% url 'explore:items' %}"
                            style="color: white; text-decoration: none;"><strong>Explore</strong></a>
                        <span class="mx-2 slash text-light">/</span>
                        <span class="text-white">Details</span>
                    </div>
                </div>

            </div>

        </div>
    </div>

</div>
<div class="container my-5 py-2 ">
    {% include 'messages.html' %}
    <div class="row" height="100vh">
        <!-- carousel Image -->
        <div class="col-md-6 col-md-push-2">

            <div id="instrument_{{item.name}}" class="carousel slide bg-light" data-interval="false">
                <div class="carousel-indicators">
                    {% for image in item.image_set.all %}
                    <button type="button" data-bs-target="#instrument_{{ item.id }}"
                        data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" {% endif %}
                        aria-label="Slide {{ forloop.counter }}">
                    </button>
                    {% endfor %}
                </div>
                <div class="carousel-inner">
                    {% for image in item.image_set.all %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}" style="background-color: #FFF;">
                        <img class="card-img-top img-fluid" src="{{ image.image.url }}"
                            alt="Slide {{ forloop.counter }}" style="max-height: 100%; max-width: 100%;">
                    </div>
                    {% endfor %}
                </div>


                <a class="carousel-control-prev" href="#instrument_{{item.name}}" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#instrument_{{item.name}}" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>


        </div>

        <!-- Item Information -->

        <div class="col-md-6 ps-3 ">

            <div class="product-details ">
                <h1 class="product-name">{{item.name}}</h1>

                <div class="product-rating">
                    <span>
                        <i class="fa fa-star {% if average_rating >= 1 %}review{% endif %}"></i>
                        <i class="fa fa-star {% if average_rating >= 2 %}review{% endif %}"></i>
                        <i class="fa fa-star {% if average_rating >= 3 %}review{% endif %}"></i>
                        <i class="fa fa-star {% if average_rating >= 4 %}review{% endif %}"></i>
                        <i class="fa fa-star {% if average_rating >= 5 %}review{% endif %}"></i>
                    </span>
                </div>


                <div>
                    <h3 class="product-price">रु {{ item.price }} </h3>

                </div>
                <ul class="product-links">
                    <li>Category:</li>
                    <li class="px-2"><a href="#"
                            style="text-decoration: none; color:#D10024;">{{item.get_item_type_display_name}}</a></li>
                    <li><a href="#" style="text-decoration: none; color:#D10024;">{{item.category}}</a></li>
                </ul>
                <p>{{ item.description | safe}}
                </p>


            </div>


            <!-- Save Button -->
            <div class="col-lg-8">
                <div class="row">
                    <div class="col-6">
                        {% if user.is_authenticated and user.role == 'customer' and user.is_verified %}
                        {% is_item_already_saved item request.user as is_saved %}
                        {% if is_saved %}
                        <form id="deleteSavedForm" action="{% url 'explore:delete-saved' item.id %}" method="POST">
                            {% csrf_token %}
                            <button class="btn save-btn" type="submit"><i class="fa-solid fa-heart-crack"></i>
                                Saved</button>
                        </form>

                        {% else %}
                        <form action="{% url 'explore:saved-item' item.id %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="item" value="{{ item.id }}">

                            <button class=" save-btn btn" type="submit"><i class="fa-solid fa-heart-crack"></i>
                                Save</button>

                        </form>
                        {% endif %}



                        {% elif user.is_authenticated and user.role == 'customer' and not user.is_verified %}
                        <button type="button" id="example" class="btn btn-danger" data-bs-toggle="popover"
                            data-bs-placement="top" data-bs-trigger="hover"
                            data-bs-content="Please Verify Account Uploading document or wait until verification">
                            Need Verification
                        </button>


                        {% elif request.user.id == item.user.id and user.role == 'lessor' and user.is_verified %}


                        <!-- Delete Confirmation Modal -->
                        <button
                            onclick="call_sw_alert_func('{% url 'explore:delete-item' item.id %}','{{ item.id }}','Once Deleted, You Will Not be Able To Recover This Post!')"
                            class="btn-danger btn-sm save-btn"><i class="fa-solid fa-xmark"></i>Delete</button>
                        {% elif request.user.id == item.user.id and user.role == 'lessor' and not user.is_verified %}

                        <button type="button" id="example" class="btn btn-danger" data-bs-toggle="popover"
                            data-bs-placement="top" data-bs-trigger="hover"
                            data-bs-content="Please Verify Account Uploading document or wait until verification">
                            Need Verification
                        </button>

                        <form action="{% url 'explore:saved-item' item.id %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="item" value="{{ item.id }}">
                            {% elif not user.is_authenticated%}
                            <button class="save-btn" type="submit"><i class="fa fa-heart"></i> Save</button>
                            {% endif %}
                        </form>
                    </div>
                    <!-- Save Button -->

                    <div class="col-6">
                        {% if user.is_authenticated and user.role == 'customer' and user.is_verified %}


                        {% is_item_already_rented item request.user as is_rented %}
                        {% if is_rented %}
                        <button type="button" class="btn btn-dark" style="font-weight: 700;
                                                                border-radius: 40px;" id="myButton1"
                            data-toggle="modal" disabled>
                            Already Rented</a>
                        </button>
                        {% else %}
                        {% if Available %}
                        <button type="button" class="rent-btn btn-md" id="myButton1" data-toggle="modal"
                            data-target="#exampleModalCenter" hidden>
                            <i class="fa fa-heart"></i> Rent Now</button>

                        {% else %}
                        <button type="button" class="btn btn-dark btn-md" style="font-weight: 700;
                                    border-radius: 40px;" id="myButton1" data-toggle="modal"
                            data-target="#exampleModalCenter">
                            Rent Now
                        </button>


                        {% endif %}
                        {% endif %}
                        {%if Available%}
                        <!-- Trigger button to open the modal -->
                        <button type="button" class="btn btn-outline-dark booked" data-toggle="modal"
                            data-target="#bookingModal">
                            Book
                        </button>

                        {%endif%}




                        {% elif user.is_authenticated and request.user.id == item.user.id and user.role == 'lessor' and user.is_verified %}





                        <a href="{% url 'explore:edit-item' item.id %}" class="btn btn-outline-dark book-now"
                            style="padding-top:6px;">Edit</a>





                        {% elif request.user.id == item.user.id and user.role == 'lessor' and not user.is_verified %}
                        <button type="button" id="example" class="btn btn-outline-danger" data-bs-toggle="popover"
                            data-bs-placement="top" data-bs-trigger="hover"
                            data-bs-content="Please Verify Account Uploading document or wait until verification"
                            hidden>
                            Need Verification
                        </button>





                        {% elif not user.is_verified and user.role == 'customer' %}

                        <button type="button" id="example" class="btn btn-outline-danger" data-bs-toggle="popover"
                            data-bs-placement="top" data-bs-trigger="hover"
                            data-bs-content="Please Verify Account Uploading document or wait until verification. "
                            hidden>
                            Need Verifiation
                        </button>


                        {%elif not user.is_authenticated%}

                        <a class="btn btn-outline-dark book-now"
                            href="{% url 'accounts:login' %}?next={% url 'explore:details' item.id %}"
                            style="padding-top:6px;">Login</a>


                        {%endif%}

                    </div>
                </div>


                <!-- saved item -->


            </div>







        </div>
    </div>
    <!-- If Items are ot available for this day -->

    {%if NotAvailable%}
    <div class="container">
        <div id="success-alert" class="alert alert-success alert-dismissible fade show my-2" role="alert">
            <strong>Item is not Available for this dates!!</strong>
            <p>
                {{Message}}
            </p>
            <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close">

            </button>
        </div>
    </div>
    {%endif%}

    {%if Incorrect_dates%}
    <div class="container">
        <div class="alert alert-danger alert-dismissible fade show my-2" role="alert">
            <strong>{{Incorrect_dates}}</strong>
            <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close">

            </button>
        </div>
    </div>
    {%endif%}

    {%if Available%}

    <div class="container">
        <div id="success-alert" class="alert alert-success alert-dismissible fade show my-2" role="alert">
            <strong>Item Details.</strong>
            {%if Message%}
            <p>
                {{Message}}.
            </p>
            {%endif%}
            <button type="button" class="btn-close" data-dismiss="alert" aria-label="Close">

            </button>
        </div>
    </div>




    <!-- Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" role="dialog" aria-labelledby="bookingModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-dark">
                    <h5 class="modal-title text-light" id="bookingModalLabel">Book Items</h5>
                    <button type="button" class="close btn btn-outline-light" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="rentForm" action="{% url 'explore:rent-item' item.id %}" method="post">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-6 mb-2">
                                <label for="pickupdate"><b>Pickup Date</b></label>
                                <input type="text" class="form-control " id="pickupdate" name="Rentitem_Date_of_Booking"
                                    value="{{rent_data.Rentitem_Date_of_Booking}}" readonly>
                            </div>
                            <div class="form-group col-6 mb-2">
                                <label for="returndate"><b>Return Date</b></label>
                                <input type="text" class="form-control" id="returndate" name="Rentitem_Date_of_Return"
                                    value="{{rent_data.Rentitem_Date_of_Return}}" readonly>
                            </div>
                            <div class="form-group col-6 mb-2">
                                <label for="time"><b>Time:</b></label>
                                <input type="time" id="time" name="time">
                            </div>
                            <div class="form-group mb-2">
                                <label for="totaldays"><b>Total days</b></label>
                                <input type="text" class="form-control" id="totaldays" name="Total_days"
                                    value="{{rent_data.days}}" readonly>
                            </div>
                            <div class="form-group mb-2">
                                <label for="totalamount"><b>Total Amount</b></label>
                                <input type="text" class="form-control" id="totalamount" name="Rentitem_Total_amount"
                                    value="{{rent_data.total}}" readonly>
                            </div>
                            <!-- Button to open the map for location selection -->
                            <button type="button" class="btn btn-danger my-3 me-2" onclick="openMap()">Select
                                Location</button>
                            <button type="button" class="btn btn-danger my-3" onclick="useMyLocation()">Use My
                                Location</button>


                            <!-- Map container -->
                            <div id="map" style="height: 400px;"></div>

                            <!-- Add fields for capturing user location -->
                            <input type="hidden" name="latitude" id="latitude" value="">
                            <input type="hidden" name="longitude" id="longitude" value="">

                            {% is_item_already_rented item request.user as is_rented %}
                            {% if is_rented %}
                            <button type="button" class="btn btn-success btn-md" disabled>
                                Already Rented
                            </button>
                            {% else %}
                            <button onclick="Pay_Khalti(event)" class="btn btn-secondary btn-md"
                                style="background-color: rgb(107, 8, 168); color: white; margin-top: 15px;">
                                Pay with Khalti
                            </button>
                            {% endif %}

                        </div>
                    </form>
                    {%endif%}
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="margin-right: 0;">

        <div class="col-md-12 col-sm-12">
            <div class="p-lg-5 p-sm-2 bg-white rounded shadow mb-5 ">
                <!-- Bordered tabs-->
                <ul id="myTab1" role="tablist"
                    class="nav nav-tabs nav-pills with-arrow flex-column flex-sm-row text-center ">
                    <li class="nav-item flex-sm-fill mx-2">
                        <a id="home1-tab" data-toggle="tab" href="#home1" role="tab" aria-controls="home1"
                            aria-selected="true"
                            class="nav-link text-uppercase font-weight-bold mr-sm-3 rounded-5 border active">Related
                            Items</a>
                    </li>
                    <li class="nav-item flex-sm-fill mx-2">
                        <a id="profile1-tab" data-toggle="tab" href="#profile1" role="tab" aria-controls="profile1"
                            aria-selected="false"
                            class="nav-link text-uppercase font-weight-bold mr-sm-3 rounded-5 border">Location</a>
                    </li>
                    <li class="nav-item flex-sm-fill mx-2">
                        <a id="contact1-tab" data-toggle="tab" href="#contact1" role="tab" aria-controls="contact1"
                            aria-selected="false"
                            class="nav-link text-uppercase font-weight-bold rounded-5 border">Review</a>
                    </li>
                </ul>
                <div id="myTab1Content" class="tab-content">
                    <div id="home1" role="tabpanel" aria-labelledby="home-tab" class="tab-pane fade py-5 show active ">
                        <div class="container">
                            <div class="row">
                                {% for item in page_obj %}
                                <div class="col-lg-4 col-md-4 col-sm-6 my-3  " data-aos="zoom-in-up">
                                    <div class="card shadow mb-5 h-80 explore-card" style="width: Auto">
                                        <div id="instrument_{{item.id}}" class="carousel slide"
                                            data-bs-interval="false">
                                            <div class="carousel-indicators">
                                                {% for image in item.image_set.all %}
                                                <button type="button" data-bs-target="#instrument_{{ item.id }}"
                                                    data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first
                                                    %}class="active" {% endif %
                                                    aria-label="Slide {{ forloop.counter }}">
                                                </button>
                                                {% endfor %}
                                            </div>
                                            <div class="carousel-inner">
                                                {% for image in item.image_set.all %}
                                                <div class="carousel-item {% if forloop.first %}active{% endif %}"
                                                    style="height: 200px;">
                                                    <img class="card-img-top" src="{{ image.image.url }}"
                                                        alt="Slide {{ forloop.counter }}">
                                                </div>
                                                {% endfor %}
                                            </div>

                                            <button class="carousel-control-prev" type="button"
                                                data-bs-target="#instrument_{{ item.id }}" data-bs-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Previous</span>
                                            </button>
                                            <button class="carousel-control-next" type="button"
                                                data-bs-target="#instrument_{{ item.id }}" data-bs-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Next</span>
                                            </button>
                                        </div>

                                        <div class="card-body">


                                            <div class="product-body justify-content-center">
                                                <span
                                                    class="badge badge-lg rounded-pill bg-danger text-black mb-2">{{item.get_item_type_display_name}}</span>
                                                <p class="product-category">{{item.category}}</p>
                                                <h3 class="product-name"><a href="{% url 'explore:details' item.id  %}">
                                                        {{ item.name}}</a></h3>
                                                <h4 class="product-price">रु {{ item.price }} </h4>






                                                <div class="product-btns justify-content-center"
                                                    style="background-color: rgba(0, 0, 0, 0);  ">

                                                    <a class="add-to-wishlist" href="" style="margin-right: 15px;"><i
                                                            class="fa fa-heart-o fa-lg"></i><span class="tooltipp">Save
                                                            Item</span></a>

                                                    <a href="{% url 'explore:details' item.id  %}" class="quick-view"><i
                                                            class="fa fa-eye fa-lg"></i><span class="tooltipp">
                                                            view details</span></a>
                                                </div>


                                            </div>



                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% include 'paginator.html' %}
                    </div>

                    <div id="profile1" role="tabpanel" aria-labelledby="profile-tab" class="tab-pane fade px-4 py-5">
                        <div class="mx-auto" id="itemmap" style="height: 400px; width: 100%; "></div>
                    </div>
                    <div id="contact1" role="tabpanel" aria-labelledby="contact-tab" class="tab-pane fade py-5">
                        <div class="container" style="margin-right: 0;">

                            <h2>Add Rating and Review</h2>
                            {% if user.is_authenticated and user.role == 'customer' and user.is_verified %}

                            <hr>
                            <form class="rate-form text-center " action="{% url 'explore:add-rate' item.id %}"
                                method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="id" value="{{ item.id }}">
                                <input type="hidden" name="val" value="">
                                <button type="button" class="fa fa-star fa-2x my-btn" data-value="1"></button>
                                <button type="button" class="fa fa-star fa-2x my-btn" data-value="2"></button>
                                <button type="button" class="fa fa-star fa-2x my-btn" data-value="3"></button>
                                <button type="button" class="fa fa-star fa-2x my-btn" data-value="4"></button>
                                <button type="button" class="fa fa-star fa-2x my-btn" data-value="5"></button>
                                <textarea name="comment" placeholder="Enter your comment"
                                    class="form-control mt-3 comments"></textarea>
                                <span><button type="button" class="mt-3 btn btn-danger"
                                        id="add-review-btn">Post</button></span>
                            </form>

                            <hr>

                            {% for review in reviews %}
                            <div class="row">


                                <div class="col-lg-2 col-md-6">
                                    <div class="user-image">
                                        <img src="{{review.user.photo.url}}" alt="" height="50px" width="50px"
                                            style="border-radius: 50%;">
                                    </div>
                                    <div id="reviews">

                                        <ul class="reviews">
                                            <li style="list-style: none;">


                                                <div class="review-heading">
                                                    <p class="name">{{review.user.get_full_name}}</p>
                                                    <p class="date">27 DEC 2018, 8:0 PM</p>
                                                    <div class="review-rating">
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 1 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 2 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 3 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 4 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 5 %}review{% endif %}"></i>
                                                    </div>
                                                </div>

                                            </li>

                                        </ul>

                                    </div>
                                </div>
                                <div class="col-lg-9 col-md-6">
                                    <div class="review-body">
                                        <p align="justify" style="word-break:break-all;">{{ review.comment }}</p>
                                    </div>

                                </div>
                            </div>



                            <hr>
                            {% empty %}
                            <p>No reviews yet.</p>
                            {% endfor %}


                            {%else %}
                            <span class="avg_star mb-3">
                                <i class="fa fa-star fa-2x {% if average_rating >= 1 %}review{% endif %}"></i>
                                <i class="fa fa-star fa-2x {% if average_rating >= 2 %}review{% endif %}"></i>
                                <i class="fa fa-star fa-2x {% if average_rating >= 3 %}review{% endif %}"></i>
                                <i class="fa fa-star fa-2x {% if average_rating >= 4 %}review{% endif %}"></i>
                                <i class="fa fa-star fa-2x {% if average_rating >= 5 %}review{% endif %}"></i>
                            </span>
                            <hr>

                            {% for review in reviews %}
                            <div class="row">


                                <div class="col-lg-2 col-md-6">
                                    <div class="user-image">
                                        <img src="{{review.user.photo.url}}" alt="" height="50px" width="50px"
                                            style="border-radius: 50%;">
                                    </div>
                                    <div id="reviews">

                                        <ul class="reviews">
                                            <li style="list-style: none;">


                                                <div class="review-heading">
                                                    <p class="name">{{review.user.get_full_name}}</p>
                                                    <p class="date">27 DEC 2018, 8:0 PM</p>
                                                    <div class="review-rating">
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 1 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 2 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 3 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 4 %}review{% endif %}"></i>
                                                        <i
                                                            class="fa fa-star {% if review.rating >= 5 %}review{% endif %}"></i>
                                                    </div>
                                                </div>

                                            </li>

                                        </ul>

                                    </div>
                                </div>
                                <div class="col-lg-9 col-md-6">
                                    <div class="review-body">
                                        <p align="justify" style="word-break:break-all;">{{ review.comment }}</p>
                                    </div>

                                </div>
                            </div>



                            <hr>
                            {% empty %}
                            <p>No reviews yet.</p>
                            {% endfor %}



                            {% endif %}
                        </div>

                    </div>

                </div>
            </div>
        </div>
        <!-- End bordered tabs -->

    </div>
</div>










<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header text-center bg-dark">
                <h5 class="modal-title text-light" id="exampleModalLongTitle">Check
                    Availability</h5>
                <button type="button" class="close btn btn-light" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">


                </h5>
                <form action="{% url 'explore:CheckAvailability' item.id %}" class="px-4 py-3 bg-light " method="post"
                    enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-row bg-light">

                        <div class="modal-body bg-light">
                            <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')"
                                name="Rentitem_Date_of_Booking" class="form-control" placeholder="Pickup date" required>


                            <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')"
                                name="Rentitem_Date_of_Return" class="form-control mt-3" placeholder="Return date"
                                required>

                        </div>


                        <div class="modal-footer text-center justify-content-center bg-light ">

                            <input type="submit" class="btn btn-outline-dark" value="Check Availability" />
                            <button class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
                        </div>

                    </div>
                </form>

            </div>

        </div>
    </div>
</div>


</div>


<!-- iTEMS LOCATION -->


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<!-- Make sure you put this AFTER Leaflet's CSS -->
<!-- Link to Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Script to initialize Leaflet map -->
<script>
    // Function to initialize Leaflet map
    function initMap(latitude, longitude) {
        // Initialize map
        var map = L.map('itemmap').setView([latitude, longitude], 12);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var redIcon = L.icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            tooltipAnchor: [16, -28],
            shadowSize: [41, 41]
        });

        // Add a marker with the custom red icon for the location
        L.marker([parseFloat(latitude), parseFloat(longitude)], { icon: redIcon }).addTo(map)
            .bindPopup(`{{item.name}}'s Location`)
            .openPopup();


    }


    // Set latitude and longitude for testing
    var latitude = {{ item.latitude }}; // Example latitude
    var longitude = {{ item.longitude }}; // Example longitude
    console.log(latitude)
    setTimeout(function () {
        initMap(latitude, longitude);
    }, 3500); 
    
</script>

<!-- for popover -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    });
</script>

<!-- Include Khalti Checkout Web library -->
<script src="https://unpkg.com/khalti-checkout-web"></script>


<!-- Include Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Include Leaflet library -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


<!-- Rent Item Script -->

<!-- Script to handle opening the map -->
<script>
    var mymap;
    var marker;

    function openMap() {
        mymap = L.map('map').setView([27.7172, 85.3240], 12);


        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(mymap);

        marker = L.marker([51.505, -0.09], { draggable: true }).addTo(mymap);

        // Function to update hidden input fields with marker's coordinates
        function updateMarkerCoordinates() {
            document.getElementById('latitude').value = marker.getLatLng().lat;
            document.getElementById('longitude').value = marker.getLatLng().lng;
        }

        // Initial update of hidden input fields
        updateMarkerCoordinates();

        // Event listener for marker dragend
        marker.on('dragend', function (e) {
            // Update hidden input fields with marker's new coordinates
            updateMarkerCoordinates();
        });

        // Event listener for map click
        mymap.on('click', function (e) {
            // Move marker to the clicked location
            marker.setLatLng(e.latlng);
            // Update hidden input fields with marker's new coordinates
            updateMarkerCoordinates();
        });
    }

    function useMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);

                // Set marker to user's current location
                marker.setLatLng(userLatLng);
                mymap.setView(userLatLng);

                // Update hidden input fields with user's current coordinates
                updateMarkerCoordinates();
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    }
</script>

<script>
    const csrf_token = "{{ csrf_token }}";

    async function Pay_Khalti(event) {
        event.preventDefault();

        // Replace 'yourapp' with your actual Django app name
        // const emailSendingEndpoint = '/explore:send_email_after_payment/';

        // Get the total amount from Django context
        const amt = '{{ rent_data.total }}';
        const mail_1 = '{{ item.user.email }}';
        const mail_2 = '{{ request.user.email }}';

        async function sendEmailAfterPayment() {
            try {
                const response = await fetch('{% url "explore:send_email_after_payment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf_token,
                    },
                    body: JSON.stringify({
                        lessor_email: mail_1,
                        customer_email: mail_2,
                    }),
                });

                console.log(response.status);
                // Handle the response as needed
            } catch (error) {
                console.error(error);
            }
        }

        const config = {
            publicKey: "test_public_key_61122209af3a49b280ae500817fb0a73",
            productIdentity: 1,
            productName: "Muse rental HUb",
            productUrl: "http://127.0.0.1:8000/",
            eventHandler: {
                onSuccess: async (payload) => {
                    try {
                        // Call pays function to handle payment
                        await pays(payload.token, payload.amount);

                        // Find the form element
                        const form = document.getElementById('rentForm');
                        await sendEmailAfterPayment();
                        // Submit the form
                        form.submit();

                        // Send email after successful payment

                    } catch (error) {
                        console.error(error);
                    }
                },
                onError: (error) => {
                    console.log(error);
                },
                onClose: () => {
                    // Handle modal close
                },
            },
            paymentPreference: [
                "KHALTI",
            ],
        };

        try {
            // Initialize KhaltiCheckout with the configuration
            const checkout = new KhaltiCheckout(config);

            // Show the checkout dialog with the specified amount
            checkout.show({ amount: amt });
        } catch (error) {
            console.log(error);
        }
    }



    async function pays(paymentToken, amount) {
        try {
            const response = await fetch('explore:khalti-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token,
                },
                body: JSON.stringify({
                    payment_token: paymentToken,
                    payment_amount: amount,
                }),
            });

            console.log(response.status);
            // Add additional logs or debugging steps as needed
        } catch (error) {
            console.error(error);
        }
    }
</script>

<script>
    // Add this script to hide the success message after 3 seconds
    document.addEventListener("DOMContentLoaded", function () {
        var successAlert = document.getElementById('success-alert');
        if (successAlert) {
            setTimeout(function () {
                successAlert.style.display = 'none';
            }, 3000); // 3000 milliseconds (3 seconds)
        }
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('.rate-form');
        const stars = document.querySelectorAll('.my-btn');
        const addReviewBtn = document.getElementById('add-review-btn');

        const handleStarSelect = (size) => {
            stars.forEach((star, index) => {
                if (index < size) {
                    star.classList.add('checked');
                } else {
                    star.classList.remove('checked');
                }
            });
            form.querySelector('input[name="val"]').value = size; // Set the value for the rating
        };

        stars.forEach((star, index) => {
            star.addEventListener('mouseover', () => {
                handleStarSelect(index + 1);
            });
            star.addEventListener('click', () => {
                handleStarSelect(index + 1);
            });
        });

        addReviewBtn.addEventListener('click', () => {
            const val = form.querySelector('input[name="val"]').value;

            if (!val) {
                alert('Please select a rating before submitting.');
            } else {
                form.submit(); // Submit the form if rating is selected
            }
        });
    });
</script>

{% endblock %}